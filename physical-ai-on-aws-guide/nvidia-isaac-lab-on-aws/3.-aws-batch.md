# 3. AWS Batch를 활용한 대규모 학습

AWS Batch는 AWS 클라우드에서 워크로드의 양과 규모에 따라 컴퓨팅 리소스를 자동으로 프로비저닝하고 워크로드 분산을 최적화합니다. 모든 규모의 학습 작업을 실행할 수 있도록 지원합니다.

학습을 가속화하기 위해 4개의 GPU가 장착된 두 개의 노드에서 Isaac Lab의 RL을 실행합니다.

### 1. \[ECR] IsaacSim 실행을 위한 Docker 이미지 저장

학습 수행을 위해 설정한 Dockerfile을 [ECR(Elastic Container Registry)](https://docs.aws.amazon.com/ko_kr/AmazonECR/latest/userguide/what-is-ecr.html)에 푸시합니다. 이를 통해 AWS Batch 작업 실행 시 여러 노드가 중앙 저장소에서 동일한 컨테이너 이미지를 가져와 일관된 환경에서 학습을 진행할 수 있습니다.

AWS 콘솔에서 AWS ECR 에 들어와 **`isaaclab-batch`** - **View push commands** 를 선택해, ECR에 푸시하기 위한 명령어를 확인합니다.

<figure><img src="../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

인스턴스의 터미널 창에서 아래와 같은 명령어를 입력하여 ECR에 로그인 합니다. 아래 커맨드는 예시로, 실제로는 콘솔에서 보여지는 커맨드를 복사하여 입력해야 합니다.

```bash
# 인증 토큰을 가져와 Docker 클라이언트를 ECR 레지스트리에 인증
aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin <AWS Account ID>.dkr.ecr.us-east-1.amazonaws.com

# Docker 이미지 빌드 (이미지가 이미 빌드된 경우 이 단계 skip)
docker build -t isaaclab-batch .

# 빌드가 완료되면 해당 이미지에 태그
docker tag isaaclab-batch:latest <AWS Account ID>.dkr.ecr.us-east-1.amazonaws.com/isaaclab-batch:latest 

# 이 이미지를 ECR 레포지토리에 푸시
docker push <AWS Account ID>.dkr.ecr.us-east-1.amazonaws.com/isaaclab-batch:latest
```

<figure><img src="../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

***

### 2. \[AWS Batch] Compute Environment 생성

AWS Batch의 Compute Environment는 작업이 실행되는 컴퓨팅 리소스 모음입니다. AWS Batch는 두 가지 유형의 컴퓨팅 환경을 지원합니다.

* AWS에서 프로비저닝 및 관리하는 관리형 컴퓨팅 환경
* 고객이 관리하는 비관리형 컴퓨팅 환경

<figure><img src="../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

1. AWS Console에서 **AWS Batch** 선택
2. 왼쪽 탐색 창에서 **Ènvironment** 을 선택하고, 오른쪽 상단에서 **Create environment** - **Compute environment** 선택
3. 컴퓨팅 환경 구성에서 **Amazon Elastic Compute Cloud(EC2)** 선택

* **Orchestration type**: `Managed`
* **Name**: `IsaacLabComputeResource`
* **Instance role**: `BatchEC2ComputeResourceRole`

4. **Instance configuration**

<figure><img src="../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

* **Allowed instance types:** `g6.12xlarge`
* **Launch templates:** `BatchEC2LaunchTemplate`

5.  **Network configuration**

    <figure><img src="../../.gitbook/assets/image (20).png" alt=""><figcaption></figcaption></figure>

* **VPC ID**: `IsaacLab-VPC`
* **Subnets**: `IsaacLab-PrivateB`
* **Security groups**: (default)

6. **Create compute environment**

***

### 3. \[AWS Batch] Job Definitions 생성

Job definitions은 실행할 작업, 매개변수, 환경 변수, 컴퓨팅 요구 사항 및 작업 실행을 최적화하는 데 사용되는 기타 정보를 설정합니다.

1. **Job definitions** 선택 - **Create** 버튼
2. **Job과 오케스트레이션 타입 설정**

<figure><img src="../../.gitbook/assets/image (21).png" alt=""><figcaption></figcaption></figure>

* **Orchestration type**: `Amazon Elastic Compute Cloud(Amazon EC2)`
* **Job type**: `multi-node parallel` 선택

3. **Job definition 설정**

<figure><img src="../../.gitbook/assets/image (22).png" alt=""><figcaption></figcaption></figure>

* \[General configuration] **Name**: `IsaacLabJobDefinition`
* \[General configuration] **Execution timeout**: `3600`
* \[Node properties] **Number of nodes**: `2`
* \[Node properties] **Instance type**: `g6.12xlarge`

4. **Job definitions 생성**

<figure><img src="../../.gitbook/assets/image (28).png" alt=""><figcaption></figcaption></figure>

* **Image**: (issaclab-batch ECR 이미지)
* **vCPUs**: `16`
* **Memory**: `60000`
* **GPU**: `4`
* **Command**: `["./distributed_run.bash"]`
* **Environment variables**

| Environment variable | Value                      | Description                                                                                                                                    |
| -------------------- | -------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| TASK                 | Isaac-Velocity-Rough-H1-v0 | Isaac Lab 예제 코드                                                                                                                                |
| NCCL\_SOCKET\_IFNAME | eth0                       | 다중 노드 통신을 위한 Elastic Network Interface (ENI)                                                                                                   |
| ACCEPT\_EULA         | Y                          | [NVIDIA Omniverse License Agreement ](https://docs.omniverse.nvidia.com/isaacsim/latest/common/NVIDIA_Omniverse_License_Agreement.html)라이센스 동의 |
| PRIVACY\_CONSENT     | Y                          | 데이터 수집 동의 ([Omniverse Data Collection & Use FAQ](https://docs.omniverse.nvidia.com/utilities/latest/common/data-collection.html))              |
| PROC\_PER\_NODE      | 4                          | 현재 서버에 있는 GPU 개수                                                                                                                               |
| MAX\_ITERATIONS      | 100                        | 강화 학습을 위한 epochs 수                                                                                                                             |

* **Linux parameters**
  * **Shared memory size**: `60000`

<figure><img src="../../.gitbook/assets/image (27).png" alt=""><figcaption></figcaption></figure>

***

### 4. \[AWS Batch] Job Queue 생성

Job은 [Job queues](https://docs.aws.amazon.com/batch/latest/userguide/job_queues.html)에 제출되어 컴퓨팅 환경에서 실행되도록 예약될 때까지 대기합니다. 여러 개의 작업 큐를 구성할 수 있습니다. 작업 큐에는 우선순위가 있으며, 스케줄러는 이 우선순위를 사용하여 어떤 큐의 작업을 먼저 실행할지 결정합니다.

1. **Job queues** 선택 - **Create** 선택

* **Orchestration type**: `Amazon Elastic Compute Cloud(Amazon EC2)`
* **Name**: `IsaacLabJobQueue`
* **Connected compute environments**: `IsaacLabComputeResource`

<figure><img src="../../.gitbook/assets/image (29).png" alt=""><figcaption></figcaption></figure>

***

### 5. \[AWS Batch] Job 시작

Job Queue를 생성한 후에는 Queue에 Job을 제출할 수 있습니다.

Isaac Lab 강화 학습을 위한 멀티 노드 및 멀티 GPU Job을 생성하고, AWS Batch의 Job Queue 에 제출합니다. Job definitions에 지정된 여러 매개변수를 런타임에 재정의할 수 있습니다.

1\. **Job** 선택 - **Submit new job** 선택

* **Name**: `IsaacLab-HumanoidJob`
* **Job definition**: `IsaacLabJobDefinition`
* **Job queue**: `IsaacLabJobQueue`

<figure><img src="../../.gitbook/assets/image (30).png" alt=""><figcaption></figcaption></figure>

2. Running 상태가 되면 Nodes 탭에서 2개의 EC2 노드를 확인할 수 있습니다.

<figure><img src="../../.gitbook/assets/image (33).png" alt=""><figcaption></figcaption></figure>

3. Log stream을 선택해서 CloudWatch Log Group에 기록되는 학습 매트릭 정보를 확인할 수 있습니다.

<figure><img src="../../.gitbook/assets/image (35) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Job이 시작되면 사용 중인 2개 노드의 8개 GPU에서 완료하는 데 약 12분이 소요됩니다. 다만, GPU 할당이 되지 않아 Job 시작이 늦어질 수 있습니다.
{% endhint %}
